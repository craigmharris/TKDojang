#!/bin/bash
#
# Pre-commit hook: Auto-generate content version hashes
#
# PURPOSE: Automatically update ContentVersion.swift when JSON content changes
# INSTALL: Run `bash Scripts/install-git-hooks.sh` once per repository clone
#
# WHY: Ensures content hashes are always up-to-date without manual intervention
# - Runs only when committing (not every build)
# - No Xcode build sandbox issues
# - Zero chance of forgetting to update hashes

set -e

# Colours for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}üîç Pre-commit: Checking content changes...${NC}"

# Check if any JSON content files are staged
CONTENT_CHANGED=false

# Check for staged changes in content directories
if git diff --cached --name-only | grep -q "TKDojang/Sources/Core/Data/Content/.*\.json$"; then
    CONTENT_CHANGED=true
    echo -e "${YELLOW}üìù Content JSON files changed${NC}"
fi

if git diff --cached --name-only | grep -q "TKDojang/Sources/belt_system\.json$"; then
    CONTENT_CHANGED=true
    echo -e "${YELLOW}üìù Belt system JSON changed${NC}"
fi

# If content changed, regenerate hashes
if [ "$CONTENT_CHANGED" = true ]; then
    echo -e "${YELLOW}‚öôÔ∏è  Regenerating content hashes...${NC}"

    # Run the hash generation script
    if bash Scripts/update-content-hashes-dev.sh; then
        # Check if ContentVersion.swift was modified
        if git diff --name-only TKDojang/Sources/Core/Data/ContentVersion.swift | grep -q "ContentVersion.swift"; then
            echo -e "${GREEN}‚úÖ ContentVersion.swift updated with new hashes${NC}"

            # Stage the updated file
            git add TKDojang/Sources/Core/Data/ContentVersion.swift
            echo -e "${GREEN}‚úÖ Staged updated ContentVersion.swift${NC}"
        else
            echo -e "${GREEN}‚úÖ Content hashes unchanged (JSON changes didn't affect hashes)${NC}"
        fi
    else
        echo -e "${RED}‚ùå Hash generation failed${NC}"
        exit 1
    fi
else
    echo -e "${GREEN}‚úÖ No content changes detected, skipping hash generation${NC}"
fi

echo -e "${GREEN}‚úÖ Pre-commit hook complete${NC}"
exit 0
